<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APG-AI Prompt Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --background-dark: #121212;
            --surface-dark: #1E1E1E;
            --input-bg: #2a2a2c;
            --primary-glow: #A78BFA; /* Lavender */
            --secondary-glow: #F472B6; /* Pink */
            --text-primary: #EAEAEA;
            --text-secondary: #A0A0A0;
            --border-color: #333333;
            --border-color-focus: var(--primary-glow);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-dark); color: var(--text-primary); }
        .apg-gradient-text { background-image: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); background-clip: text; -webkit-background-clip: text; color: transparent; }
        .glow-button { background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); transition: all 0.3s ease; box-shadow: 0 0 15px rgba(167, 139, 250, 0.3); }
        .glow-button:hover { box-shadow: 0 0 25px rgba(167, 139, 250, 0.5); transform: scale(1.02); }
        .glow-button:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }
        .secondary-button { background-color: var(--surface-dark); border: 1px solid var(--border-color); color: var(--text-primary); transition: background-color 0.2s; }
        .secondary-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        textarea:focus, input:focus { outline: none; box-shadow: 0 0 15px rgba(167, 139, 250, 0.2); border-color: var(--border-color-focus) !important; }
        .step-item.active .step-circle { background-color: var(--primary-glow); border-color: var(--primary-glow); color: var(--background-dark); transform: scale(1.1); }
        .step-item.active .step-text { color: var(--text-primary); font-weight: 600; }
        .step-item .step-circle { transition: all 0.3s ease; }
        .step-line { background-color: var(--border-color); }
        textarea, input, pre { background-color: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 0.5rem; }

        .attachment-toolbar { position: relative; display: flex; align-items: center; }
        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background-color: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            margin: 0 4px;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .toolbar-btn:hover { background-color: #333; color: var(--text-primary); }
        .options-menu {
            position: absolute;
            bottom: 60px;
            left: -10px;
            display: flex;
            padding: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transform: translateY(10px);
            visibility: hidden;
            transition: all 0.2s ease-out;
            z-index: 10;
        }
        .options-menu.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .file-input { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <nav class="w-full max-w-7xl mx-auto mb-8">
        <div class="flex justify-between items-center bg-surface-dark p-4 rounded-xl border border-border-color">
            <a href="index.html" class="text-2xl font-bold apg-gradient-text">APG Generator</a>
            <a href="index.html" class="secondary-button !rounded-full !px-6 !py-2">
                <i class="fa-solid fa-arrow-left mr-2"></i>Back to Home
            </a>
        </div>
    </nav>

    <div class="w-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-5 gap-8">

        <div class="md:col-span-3">
            <div class="w-full bg-surface-dark p-6 rounded-2xl border border-border-color">
                <div id="tool-view">
                    
                    <div class="flex items-center justify-center w-full mb-8">
                        <div class="step-item flex items-center text-text-secondary" id="step-1-indicator"><div class="step-circle w-8 h-8 rounded-full bg-surface-dark border-2 border-border-color flex items-center justify-center font-bold">1</div><span class="step-text ml-3">Goal</span></div>
                        <div class="step-line flex-grow h-0.5 mx-4"></div>
                        <div class="step-item flex items-center text-text-secondary" id="step-2-indicator"><div class="step-circle w-8 h-8 rounded-full bg-surface-dark border-2 border-border-color flex items-center justify-center font-bold">2</div><span class="step-text ml-3">Refine</span></div>
                        <div class="step-line flex-grow h-0.5 mx-4"></div>
                        <div class="step-item flex items-center text-text-secondary" id="step-3-indicator"><div class="step-circle w-8 h-8 rounded-full bg-surface-dark border-2 border-border-color flex items-center justify-center font-bold">3</div><span class="step-text ml-3">Generate</span></div>
                    </div>

                    <div id="step-1-content">
                        <h3 class="text-2xl font-semibold mb-4">What's your topic or goal?</h3>
                        <div class="relative w-full">
                            <textarea id="topic-input" rows="5" class="w-full p-3 pr-12 rounded-lg border border-border-color transition-colors duration-200" placeholder="e.g., A marketing campaign for a new coffee brand"></textarea>
                            <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 10px; top: 10px; width: 36px; height: 36px;" title="Voice Input">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                        
                        <div class="attachment-toolbar mt-4">
                            <button type="button" id="toggleBtn" class="toolbar-btn" title="Add attachments">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                    
                            <div id="optionsMenu" class="options-menu">
                                <label for="photoUpload" class="toolbar-btn" title="Add Photo">
                                    <i class="fa-solid fa-image"></i>
                                </label>
                                <input type="file" id="photoUpload" class="file-input" accept="image/*">
                                <label for="fileUpload" class="toolbar-btn" title="Add File">
                                    <i class="fa-solid fa-paperclip"></i>
                                </label>
                                <input type="file" id="fileUpload" class="file-input">
                            </div>
                        </div>

                        <button id="step-1-btn" class="glow-button !rounded-full text-white font-semibold px-8 py-3 mt-6 w-full" disabled>Continue</U>
                    </div>

                    <div id="step-2-content" class="hidden">
                        <h3 id="step-2-title" class="text-2xl font-semibold mb-4">Refine your prompt.</h3>
                        <p class="text-sm text-text-secondary -mt-2 mb-4">Your prompt will update live on the right as you type.</p>
                        <div id="questions-container" class="space-y-4 text-left"></div>
                        
                        <div id="refine-options" class="hidden mt-6 flex flex-col gap-4">
                            <button id="add-input-btn" class="secondary-button !rounded-full font-semibold px-6 py-3 w-full">Add Manual Input</button>
                            <button id="more-questions-btn" class="secondary-button !rounded-full font-semibold px-6 py-3 w-full">Ask 3 More Questions</button>
                        </div>
                    </div>
                    
                    <div id="step-3-content" class="hidden"></div>
                </div>
            </div>
        </div>

        <div class="md:col-span-2">
            <div class="sticky top-8">
                <div class="bg-surface-dark p-6 rounded-xl border border-border-color min-h-[600px]">
                    <h3 class="text-2xl font-semibold text-text-primary mb-4">Live Prompt</h3>
                    
                    <div id="preview-placeholder" class="flex flex-col items-center justify-center h-[500px] text-center text-text-secondary">
                        <i class="fa-solid fa-file-lines text-6xl mb-4"></i>
                        <p class="text-lg font-medium">Click "Continue" to generate your first prompt.</p>
                    </div>

                    <div id="preview-loading" class="hidden flex-col items-center justify-center h-[500px] text-center text-primary-glow">
                        <i class="fa-solid fa-spinner fa-spin text-6xl mb-4"></i>
                        <p class="text-lg font-medium">APG is thinking...</p>
                    </div>
                    
                    <div id="preview-result" class="hidden">
                        <div id="result-container" class="text-left">
                            <pre id="result-text" class="w-full p-4 rounded-lg overflow-y-auto whitespace-pre-wrap text-sm min-h-[24rem] max-h-[40rem]"></pre>
                            <div class="flex flex-col gap-4 mt-6">
                                <button id="copy-btn" class="glow-button !rounded-full text-white font-semibold px-8 py-3 w-full"><span id="copy-text">Copy Prompt</span></button>
                                <button id="start-over-btn" class="secondary-button !rounded-full font-semibold px-8 py-3 w-full">Start Over</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <script>
        // --- 0. Debounce Helper Function ---
        function debounce(func, delay = 500) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // --- 1. DOM Elements (Modified) ---
        const dom = {
            stepIndicators: [
                document.getElementById('step-1-indicator'), 
                document.getElementById('step-2-indicator'),
                document.getElementById('step-3-indicator') // Added Step 3 back
            ],
            stepContents: [
                document.getElementById('step-1-content'), 
                document.getElementById('step-2-content')
            ],
            step1Btn: document.getElementById('step-1-btn'),
            topicInput: document.getElementById('topic-input'),
            questionsContainer: document.getElementById('questions-container'),
            step2Title: document.getElementById('step-2-title'),
            refineOptions: document.getElementById('refine-options'),
            addInputBtn: document.getElementById('add-input-btn'),
            moreQuestionsBtn: document.getElementById('more-questions-btn'),
            
            resultText: document.getElementById('result-text'),
            copyBtn: document.getElementById('copy-btn'),
            copyText: document.getElementById('copy-text'),
            startOverBtn: document.getElementById('start-over-btn'),
            
            previewPlaceholder: document.getElementById('preview-placeholder'),
            previewLoading: document.getElementById('preview-loading'),
            previewResult: document.getElementById('preview-result'),
        };

        // --- 2. State (Unchanged) ---
        let state = {
            currentStep: 0,
            userTopic: '',
            questionsAndAnswers: [],
            manualInput: '',
            generatedPrompt: ''
        };

        // --- 3. API Call Logic (Unchanged) ---
        async function callApi(prompt, systemInstruction) {
            const API_URL = `/api/generate`; 
            const payload = { prompt, systemInstruction };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    console.error("API Error from backend:", errorBody);
                    return `Error: ${errorBody.error || response.statusText}`;
                }
                const data = await response.json();
                return data.text;
            } catch (error) {
                console.error("Fetch Error to backend:", error);
                return "Error: Could not connect to the server.";
            }
        }

        // --- 4. UI Update Logic (Modified) ---

        /**
         * Controls the left panel (Steps 1 & 2)
         */
        const updateStepUI = () => {
            // Activate indicators for step 1 or 2
            dom.stepIndicators.forEach((indicator, index) => indicator.classList.toggle('active', index === state.currentStep));
            
            // Manually deactivate step 3 if we are on step 1 or 2
            if (state.currentStep < 2) {
                dom.stepIndicators[2].classList.remove('active');
            }

            // Show/hide page content
            dom.stepContents[0].classList.toggle('hidden', state.currentStep !== 0);
            dom.stepContents[1].classList.toggle('hidden', state.currentStep !== 1);
        };
        
        const updatePreviewPanel = (view) => {
            dom.previewPlaceholder.classList.toggle('hidden', view !== 'placeholder');
            dom.previewLoading.classList.toggle('hidden', view !== 'loading');
            dom.previewResult.classList.toggle('hidden', view !== 'result');
        };

        const showLoading = (container, message) => {
            container.innerHTML = `<div class="text-center text-text-secondary">${message}</div>`;
        };
        const showError = (container, message) => {
            container.innerHTML = `<div class="text-center text-red-400 p-4 bg-red-900/20 rounded-lg">${message}</div>`;
        };
        
        // --- 5. Core Logic (Modified) ---

        /**
         * Live-update function
         */
        const updateLivePrompt = async () => {
            if (state.currentStep === 0) return;

            // *** UI FIX ***: Activate Step 3 indicator
            dom.stepIndicators[2].classList.add('active'); 
            updatePreviewPanel('loading');
            
            buildStateFromForm(); 

            const qasText = state.questionsAndAnswers.map(qa => `- Question: ${qa.question}\n- Answer: ${qa.answer}`).join('\n');
            const manualInputSection = state.manualInput ? `\n**Additional User-Provided Details:**\n${state.manualInput}` : '';

            const instruction = `Your role is an expert prompt engineer. Your ONLY task is to synthesize the user's goal and their answers into a single, comprehensive, and detailed prompt ready for another AI model.
You MUST NOT answer or fulfill the user's request yourself. You are building the prompt FOR them.
The final output must ONLY be the generated prompt text, with no extra conversation, preamble, or explanations.
**User's Initial Goal:**
${state.userTopic}
**User's Refinements (Questions & Answers):**
${qasText}
${manualInputSection}
Now, generate the final, copy-and-paste-ready prompt below.`;

            const finalPrompt = await callApi("Synthesize the information into a final prompt.", instruction);
            
            if (!finalPrompt || finalPrompt.startsWith("Error:")) {
                dom.resultText.textContent = `// Error generating prompt. Please try again.\n\n${finalPrompt}`;
                updatePreviewPanel('result');
            } else {
                state.generatedPrompt = finalPrompt.trim();
                dom.resultText.textContent = state.generatedPrompt;
                updatePreviewPanel('result');
            }
        };

        const debouncedUpdateLivePrompt = debounce(updateLivePrompt, 500);

        /**
         * Loads initial questions
         */
        const loadInitialQuestions = async () => {
            dom.refineOptions.classList.add('hidden');
            showLoading(dom.questionsContainer, 'APG is preparing your refinement form...');
            
            const instruction = `...[omitted for brevity]...**Return ONLY a JSON array of 5 strings**...`;
            const questionText = await callApi("Generate 5 initial questions.", instruction);

            // *** BUG FIX ***: Check for error *before* parsing
            if (questionText.startsWith("Error:")) {
                console.error("API Error during question load:", questionText);
                showError(dom.questionsContainer, questionText);
                return;
            }

            let questions;
            try {
                questions = JSON.parse(questionText);
                if (!Array.isArray(questions) || questions.length === 0 || !questions.every(q => typeof q === 'string')) {
                    throw new Error('Invalid JSON array format.');
                }
            } catch (error) {
                console.error("Failed to parse questions:", error, questionText);
                showError(dom.questionsContainer, "Error: Could not generate questions. The AI returned an invalid format. Please try again.");
                return;
            }

            dom.step2Title.textContent = 'Refine your prompt.';
            dom.questionsContainer.innerHTML = ''; // Clear loading
            
            // This is your original HTML for the questions
            questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'question-item space-y-2 mb-4';
                questionEl.innerHTML = `
                    <label for="q-${index}" class="block text-lg font-medium text-left">${q}</label>
                    <div class="relative w-full">
                        <input type="text" id="q-${index}" data-question="${q}" class="w-full p-3 pr-12 rounded-lg border border-border-color transition-colors duration-200" placeholder="Your answer...">
                        <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px;" title="Voice Input">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <div class="text-right mt-1 space-x-4">
                        <button type="button" class="manual-input-btn-specific text-sm text-pink-400 hover:underline" data-q-index="${index}">
                            Add manual input
                        </button>
                        <button type="button" class="follow-up-btn text-sm text-primary-glow hover:underline" data-q-index="${index}">
                            Add follow-up
                        </button>
                    </div>
                    <div class="manual-input-container-specific ml-4 mt-2"></div>
                    <div class="follow-up-container ml-4 border-l-2 border-border-color pl-4 mt-2"></div>
                `;
                dom.questionsContainer.appendChild(questionEl);
            });

            dom.refineOptions.classList.remove('hidden');
            dom.addInputBtn.style.display = 'block'; 
            
            updateLivePrompt(); // Call once to generate first prompt
        };

        /**
         * Asks for more questions (Bug Fix)
         */
        const askMoreQuestions = async () => {
            dom.refineOptions.classList.add('hidden');
            const loadingEl = document.createElement('div');
            loadingEl.id = 'more-questions-loading';
            loadingEl.className = 'text-center text-text-secondary mt-4';
            loadingEl.textContent = 'APG is thinking of more questions...';
            dom.questionsContainer.appendChild(loadingEl);

            buildStateFromForm(); 
            const previousQAs = state.questionsAndAnswers.map(qa => `Q: ${qa.question}\nA: ${qa.answer}`).join('\n\n');
            const instruction = `...[omitted for brevity]...**Return ONLY a JSON array of 3 strings**...`;
            const questionText = await callApi("Generate 3 more questions.", instruction);
            document.getElementById('more-questions-loading').remove();

            // *** BUG FIX HERE ***
            // Check for an API error *before* trying to parse.
            if (questionText.startsWith("Error:")) {
                alert(questionText); // Show the actual error
                dom.refineOptions.classList.remove('hidden');
                return;
            }

            let newQuestions;
            try {
                newQuestions = JSON.parse(questionText);
                if (!Array.isArray(newQuestions) || !newQuestions.every(q => typeof q === 'string')) { 
                    throw new Error('Invalid JSON format.'); 
                }
            } catch (error) {
                // This catch block is for JSON.parse errors (chattiness)
                alert('Could not generate more questions. The AI returned an invalid format.');
                dom.refineOptions.classList.remove('hidden');
                return;
            }

            const baseIndex = dom.questionsContainer.querySelectorAll('.question-item').length;
            newQuestions.forEach((q, index) => {
                const newIndex = baseIndex + index;
                const questionEl = document.createElement('div');
                questionEl.className = 'question-item space-y-2 mb-4';
                questionEl.innerHTML = `
                    <label for="q-${newIndex}" class="block text-lg font-medium text-left">${q}</label>
                    <div class="relative w-full">
                        <input type="text" id="q-${newIndex}" data-question="${q}" class="w-full p-3 pr-12 rounded-lg border border-border-color transition-colors duration-200" placeholder="Your answer...">
                        <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px;" title="Voice Input">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <div class="text-right mt-1 space-x-4">
                        <button type="button" class="manual-input-btn-specific text-sm text-pink-400 hover:underline" data-q-index="${newIndex}">
                            Add manual input
                        </button>
                        <button type="button" class="follow-up-btn text-sm text-primary-glow hover:underline" data-q-index="${newIndex}">
                            Add follow-up
                        </button>
                    </div>
                    <div class="manual-input-container-specific ml-4 mt-2"></div>
                    <div class="follow-up-container ml-4 border-l-2 border-border-color pl-4 mt-2"></div>
                `;
                dom.questionsContainer.appendChild(questionEl);
            });
            
            dom.refineOptions.classList.remove('hidden');
        };

        const buildStateFromForm = () => {
            state.questionsAndAnswers = [];
            const inputs = dom.questionsContainer.querySelectorAll('input[type="text"][data-question], textarea[data-question]');
            
            inputs.forEach(input => {
                state.questionsAndAnswers.push({
                    question: input.dataset.question,
                    answer: input.value.trim() || "(No answer provided)"
                });
            });
            const manualInput = document.getElementById('manual-input');
            state.manualInput = manualInput ? manualInput.value.trim() : '';
        };

        // --- Per-question button handlers (Unchanged) ---
        const handleSpecificManualInputClick = (event) => {
            if (!event.target.classList.contains('manual-input-btn-specific')) { return; }
            const btn = event.target;
            btn.disabled = true;
            const qIndex = btn.dataset.qIndex;
            const mainInput = document.getElementById(`q-${qIndex}`); 
            const mainQuestionText = mainInput.dataset.question; 
            const manualInputContainer = btn.closest('.question-item').querySelector('.manual-input-container-specific');
            const inputId = `q-${qIndex}-manual`;
            manualInputContainer.innerHTML = `
                <label for="${inputId}" class="block text-lg font-medium text-left text-text-secondary">Additional details:</label>
                <div class="relative w-full">
                    <textarea id="${inputId}" data-question="(Manual Details for: ${mainQuestionText})" class="w-full p-3 pr-12 rounded-lg border border-border-color transition-colors duration-200 mt-2" rows="3" placeholder="Add your specific details here..."></textarea>
                    <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 10px; top: 10px; width: 36px; height: 36px;" title="Voice Input">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                </div>
            `;
            btn.remove();
        };

        const handleFollowUpClick = async (event) => {
            if (!event.target.classList.contains('follow-up-btn')) { return; }
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Thinking...';
            const qIndex = btn.dataset.qIndex;
            const mainInput = document.getElementById(`q-${qIndex}`);
            const mainQuestionText = mainInput.dataset.question;
            const mainAnswerValue = mainInput.value.trim();
            const followUpContainer = btn.closest('.question-item').querySelector('.follow-up-container');
            const instruction = `...[omitted for brevity]...Return ONLY the text of the single follow-up question.`;
            
            const followUpQuestionText = await callApi("Generate a follow-up question.", instruction);

            // *** BUG FIX ***: Check for error *before* parsing
            if (followUpQuestionText.startsWith("Error:")) {
                console.error("Failed to get follow-up:", followUpQuestionText);
                btn.textContent = 'Add follow-up'; 
                btn.disabled = false;
                followUpContainer.innerHTML = `<span class="text-red-400 text-sm">Could not load question. Try again.</span>`;
                setTimeout(() => { followUpContainer.innerHTML = ''; }, 3000);
                return;
            }

            if (followUpQuestionText) {
                const followUpId = `q-${qIndex}-followup`;
                followUpContainer.innerHTML = `
                    <label for="${followUpId}" class="block text-lg font-medium text-left text-text-secondary">${followUpQuestionText}</label>
                    <div class="relative w-full">
                        <input type="text" id="${followUpId}" data-question="${followUpQuestionText}" class="w-full p-3 pr-12 rounded-lg border border-border-color transition-colors duration-200 mt-2" placeholder="Your answer...">
                        <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px;" title="Voice Input">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                `;
                btn.remove(); 
            } else {
                // This block will likely not be reached due to the error check above, but it's good practice
                btn.textContent = 'Add follow-up'; 
                btn.disabled = false;
            }
        };

        // --- 7. Toolbar & Voice JS (Unchanged) ---
        const toggleButton = document.getElementById('toggleBtn');
        const optionsMenu = document.getElementById('optionsMenu');
        toggleButton.addEventListener('click', (event) => { event.stopPropagation(); optionsMenu.classList.toggle('visible'); });
        document.addEventListener('click', () => { if (optionsMenu.classList.contains('visible')) { optionsMenu.classList.remove('visible'); } });
        optionsMenu.addEventListener('click', (event) => { event.stopPropagation(); });
        const photoUpload = document.getElementById('photoUpload');
        const fileUpload = document.getElementById('fileUpload');
        photoUpload.addEventListener('change', (event) => { if (event.target.files[0]) { optionsMenu.classList.remove('visible'); } });
        fileUpload.addEventListener('change', (event) => { if (event.target.files[0]) { optionsMenu.classList.remove('visible'); } });
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let currentTargetInput = null; 
        if (recognition) {
            recognition.continuous = false; 
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (currentTargetInput) {
                    currentTargetInput.value += (currentTargetInput.value.length > 0 ? ' ' : '') + transcript;
                    if (currentTargetInput.id === 'topic-input') {
                        dom.topicInput.dispatchEvent(new Event('input'));
                    }
                    debouncedUpdateLivePrompt(); // Trigger live update
                }
            };
            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                if (currentTargetInput) { currentTargetInput.closest('.relative').querySelector('.voice-btn i').className = 'fa-solid fa-microphone'; }
            };
            recognition.onend = () => {
                if (currentTargetInput) {
                    currentTargetInput.closest('.relative').querySelector('.voice-btn i').className = 'fa-solid fa-microphone';
                    currentTargetInput = null;
                }
            };
            const handleVoiceInputClick = (event) => {
                const voiceBtn = event.target.closest('.voice-btn');
                if (!voiceBtn) return; 
                const target = voiceBtn.closest('.relative').querySelector('textarea, input[type="text"]');
                if (!target) return; 
                if (currentTargetInput) {
                    recognition.stop();
                } else {
                    currentTargetInput = target;
                    recognition.start();
                    voiceBtn.querySelector('i').className = 'fa-solid fa-stop apg-gradient-text';
                }
            };
            document.body.addEventListener('click', handleVoiceInputClick);
        } else {
            console.warn("Speech Recognition not supported.");
            const style = document.createElement('style');
            style.innerHTML = `.voice-btn { display: none; }`;
            document.head.appendChild(style);
        }
        
        // --- 8. Event Listeners & Init (Modified) ---
        const resetToStart = () => {
            state = { currentStep: 0, userTopic: '', questionsAndAnswers: [], manualInput: '', generatedPrompt: '' };
            dom.topicInput.value = '';
            dom.questionsContainer.innerHTML = '';
            dom.step1Btn.disabled = true;
            dom.refineOptions.classList.add('hidden');
            
            const manualInputEl = document.getElementById('manual-input-div');
            if(manualInputEl) manualInputEl.remove();
            dom.addInputBtn.style.display = 'block';

            updateStepUI(); 
            updatePreviewPanel('placeholder');
            dom.stepIndicators[2].classList.remove('active'); // Deactivate step 3
        };

        dom.topicInput.addEventListener('input', () => {
            dom.step1Btn.disabled = dom.topicInput.value.trim() === '';
            if (state.currentStep === 1) {
                state.userTopic = dom.topicInput.value.trim();
                debouncedUpdateLivePrompt();
            }
        });

        dom.step1Btn.addEventListener('click', () => {
            state.userTopic = dom.topicInput.value.trim();
            if (state.userTopic) {
                state.currentStep = 1;
                updateStepUI();
                loadInitialQuestions(); 
            }
        });

        dom.moreQuestionsBtn.addEventListener('click', askMoreQuestions);
        dom.addInputBtn.addEventListener('click', () => {
            dom.addInputBtn.style.display = 'none';
            const inputEl = document.createElement('div');
            inputEl.id = 'manual-input-div';
            inputEl.innerHTML = `
                <label for="manual-input" class="block text-sm font-medium mt-4 mb-2 text-left">Add any other details:</label>
                <div class="relative w-full">
                    <textarea id="manual-input" rows="4" class="w-full p-3 pr-12 rounded-lg border border-border-color"></textarea>
                    <button type="button" class="voice-btn toolbar-btn" style="position: absolute; right: 10px; top: 10px; width: 36px; height: 36px;" title="Voice Input">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                </div>
            `;
            dom.questionsContainer.appendChild(inputEl);
        });
        
        // Main live update listener
        dom.questionsContainer.addEventListener('input', debouncedUpdateLivePrompt);

        // Result Panel Listeners
        dom.copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(dom.resultText.textContent).then(() => {
                dom.copyText.textContent = 'Copied!';
                setTimeout(() => { dom.copyText.textContent = 'Copy Prompt'; }, 2000);
            });
        });
        dom.startOverBtn.addEventListener('click', resetToStart);

        // Delegated listeners for per-question buttons
        dom.questionsContainer.addEventListener('click', handleFollowUpClick);
        dom.questionsContainer.addEventListener('click', handleSpecificManualInputClick);

        // Initial UI setup
        resetToStart();
    </script>
</body>
</html>