<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APG AI Prompt Generator</title>
  <style>
    :root { --border:#e5e5e5; --muted:#666; --bg:#fafafa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .layout { display:flex; min-height:100vh; }
    aside#sidebar { width:320px; border-right:1px solid var(--border); padding:12px; overflow:auto; }
    h1,h2,h3 { margin:8px 0; }
    .muted { color: var(--muted); font-size: 12px; }
    .row { display:flex; align-items:center; gap:8px; }
    button { padding:8px 12px; border:1px solid var(--border); background:white; border-radius:8px; cursor:pointer; }
    button:hover { background: var(--bg); }
    #promptsList .prompt-item { padding:8px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; background:white; }
    #promptsList .prompt-item:hover { background: #fcfcfc; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .spaced { display:flex; justify-content:space-between; align-items:center; }
    #app { flex:1; overflow:auto; padding:16px; }
    textarea { width:100%; min-height:220px; padding:12px; border:1px solid var(--border); border-radius:10px; resize:vertical; }
    .toolbar { display:flex; gap:8px; margin-top:12px; align-items:center; }
    .output { margin-top:16px; padding:12px; border:1px dashed var(--border); border-radius:10px; background:#fff; min-height:80px; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; }
  </style>
</head>
<body>
<div class="layout">
  <aside id="sidebar">
    <div class="spaced">
      <h3>Your Prompts</h3>
      <button id="newPromptBtn" title="Add a prompt">+ New</button>
    </div>

    <div style="margin:6px 0 10px">
      <div class="row">
        <button id="googleSignInBtn">Sign in with Google</button>
        <button id="signOutBtn" style="display:none">Sign out</button>
      </div>
      <div id="userInfo" class="muted">You are not signed in.</div>
    </div>

    <div class="actions" style="margin-bottom:10px;">
      <button id="exportBtn" title="Download all prompts as JSON">Export</button>
      <button id="importBtn" title="Import prompts JSON">Import</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
    </div>

    <div id="promptsList"></div>
  </aside>

  <div id="app">
    <h2>APG AI Prompt Generator</h2>
    <div class="muted">Signed-in users can save prompts to the sidebar. It’s synced to your Google account (free).</div>

    <h3 style="margin-top:16px;">Write your prompt</h3>
    <textarea id="promptInput" placeholder="Describe what you want the model to do..."></textarea>

    <div class="toolbar">
      <button id="generateBtn">Generate</button>
      <span class="pill" id="statusPill">offline</span>
    </div>

    <div class="output" id="resultBox">
      <div class="muted">Result will appear here…</div>
    </div>
  </div>
</div>

<!-- Firebase + App Logic -->
<script type="module">
  // ---------- Firebase ESM SDKs from CDN ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy,
    serverTimestamp, doc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ---------- REPLACE with your Firebase web config (from Console) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyARNMBGTjEQc9Rjg6hyglinY091QpqazN8",
    authDomain: "apg-ai-prompt-generator.firebaseapp.com",      // like myapp.firebaseapp.com
    projectId: "apg-ai-prompt-generator",        // like myapp
    appId: "1:161631902845:web:e01084597d475ad878e514"                 // like 1:123456:web:abcdef
  };

  // ---------- Init Firebase ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ---------- DOM refs ----------
  const signInBtn   = document.getElementById('googleSignInBtn');
  const signOutBtn  = document.getElementById('signOutBtn');
  const userInfo    = document.getElementById('userInfo');
  const promptsList = document.getElementById('promptsList');
  const newPromptBtn= document.getElementById('newPromptBtn');
  const exportBtn   = document.getElementById('exportBtn');
  const importBtn   = document.getElementById('importBtn');
  const importFile  = document.getElementById('importFile');

  const promptInput = document.getElementById('promptInput');
  const generateBtn = document.getElementById('generateBtn');
  const resultBox   = document.getElementById('resultBox');
  const statusPill  = document.getElementById('statusPill');

  // ---------- Helpers ----------
  const userPromptsCol = (uid) => collection(db, `users/${uid}/prompts`);
  const escapeHtml = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // ---------- Auth ----------
  signInBtn.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  });
  signOutBtn.addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      signInBtn.style.display = 'none';
      signOutBtn.style.display = 'inline-block';
      userInfo.textContent = `Signed in as ${user.displayName || 'User'} (${user.email})`;
      statusPill.textContent = 'online';
      await renderPrompts();
    } else {
      signInBtn.style.display = 'inline-block';
      signOutBtn.style.display = 'none';
      userInfo.textContent = 'You are not signed in.';
      statusPill.textContent = 'offline';
      promptsList.innerHTML = '';
    }
  });

  // ---------- CRUD UI for Prompts ----------
  async function renderPrompts() {
    const user = auth.currentUser;
    if (!user) return;
    const q = query(userPromptsCol(user.uid), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    promptsList.innerHTML = '';
    snap.forEach((d) => {
      const p = d.data();
      const el = document.createElement('div');
      el.className = 'prompt-item';
      el.innerHTML = `
        <div><strong>${escapeHtml(p.title || 'Untitled')}</strong></div>
        <div class="muted">${escapeHtml((p.content || '').slice(0, 160))}</div>
        <div class="actions">
          <button data-id="${d.id}" class="loadBtn">Load</button>
          <button data-id="${d.id}" class="editBtn">Edit</button>
          <button data-id="${d.id}" class="deleteBtn">Delete</button>
        </div>`;
      promptsList.appendChild(el);
    });

    promptsList.querySelectorAll('.loadBtn').forEach(btn => {
      btn.onclick = async () => {
        // Simple approach: use the preview in the card
        const text = btn.closest('.prompt-item').querySelector('.muted').textContent;
        promptInput.value = text;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    });

    promptsList.querySelectorAll('.editBtn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const newTitle = prompt('New title? (leave blank to keep unchanged)');
        const newContent = prompt('New content? (leave blank to keep unchanged)');
        if (!newTitle && !newContent) return;
        await updateDoc(doc(db, `users/${auth.currentUser.uid}/prompts/${id}`), {
          ...(newTitle ? { title: newTitle } : {}),
          ...(newContent ? { content: newContent } : {})
        });
        await renderPrompts();
      };
    });

    promptsList.querySelectorAll('.deleteBtn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        if (confirm('Delete this prompt?')) {
          await deleteDoc(doc(db, `users/${auth.currentUser.uid}/prompts/${id}`));
          await renderPrompts();
        }
      };
    });
  }

  // New prompt manually
  newPromptBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert('Sign in first');
    const title = prompt('Title for this prompt?');
    const content = prompt('Paste the prompt text:');
    if (!content) return;
    await addDoc(userPromptsCol(user.uid), {
      title: title || 'Untitled',
      content,
      createdAt: serverTimestamp()
    });
    await renderPrompts();
  });

  // Export / Import
  exportBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert('Sign in first');
    const q = query(userPromptsCol(user.uid), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    const data = [];
    snap.forEach(d => data.push({ id: d.id, ...d.data() }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: 'prompts.json' });
    a.click(); URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', () => importFile.click());
  importFile.addEventListener('change', async (e) => {
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text();
    const arr = JSON.parse(text);
    const user = auth.currentUser;
    if (!user) return alert('Sign in first');
    for (const p of arr) {
      await addDoc(userPromptsCol(user.uid), {
        title: p.title || 'Untitled',
        content: p.content || '',
        createdAt: serverTimestamp()
      });
    }
    await renderPrompts();
  });

  // ---------- Demo "Generate" ----------
  // Replace with your actual /api/generate call if you have one.
  generateBtn.addEventListener('click', async () => {
    const text = promptInput.value.trim();
    if (!text) {
      resultBox.innerHTML = '<span class="muted">Please write something in the prompt box.</span>';
      return;
    }
    // Example:
    // const res = await fetch('/api/generate', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ prompt: text })
    // });
    // const data = await res.json();
    // resultBox.textContent = data.result || 'No result';

    // For now just echo:
    resultBox.textContent = `Generated (demo): ${text}`;

    // Save for signed-in users
    await savePrompt(new Date().toLocaleString(), text);
  });

  async function savePrompt(title, content) {
    const user = auth.currentUser; if (!user) return;
    await addDoc(userPromptsCol(user.uid), {
      title: title || 'Untitled',
      content,
      createdAt: serverTimestamp()
    });
    await renderPrompts();
  }
</script>
</body>
</html>
